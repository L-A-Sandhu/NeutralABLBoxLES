# NeutralABLBoxLES

This repository provides a reproducible OpenFOAM case template for a neutral atmospheric boundary layer (ABL) large-eddy simulation (LES) in a horizontally periodic box. The case models a mechanically driven boundary layer over a rough wall, uses a shear-free top boundary, and maintains a target mean streamwise velocity through a body-force term applied in a forcing slab. During the capture stage, the solver writes three-component velocity fields at an exact 0.5 s cadence, which supports consistent downstream post-processing workflows.

## Case specification

The configuration uses a structured mesh generated by `blockMesh` and a forcing cellZone constructed by `topoSet`.

- Domain size: 1800 × 800 × 600 m³  
- Mesh: 180 × 80 × 80 (structured `blockMesh`)  
- Lateral boundaries: cyclic in x and y  
- Top boundary: slip (shear free)  
- Bottom boundary: rough wall via `atmNutUWallFunction` with roughness length `z0 = 0.01 m`  
- SGS model: `dynamicLagrangian`  
- Mean-flow maintenance: `meanVelocityForce` applied to a `cellZone` (forcing slab centered near z ≈ 90 m)  
- Capture sampling: write interval = 0.5 s (adjustable run time)

## Dependencies

- OpenFOAM.com (tested with v2412)
- MPI runtime (recommended for parallel runs)
- Python 3 (for `export_cube.py`; requires NumPy and Matplotlib)

## Clone and rebuild the mesh

This repository is intentionally lightweight and does not track generated mesh connectivity. After cloning, rebuild the mesh and forcing zone before running:

```bash
# from the case root
blockMesh
topoSet
```

`blockMesh` generates `constant/polyMesh/`. `topoSet` generates the forcing `cellZone` referenced by `meanVelocityForce`.

## Run the simulation

### Option A  Wrapper script (recommended)

The wrapper creates a timestamped run directory under `runs/`, performs spin-up, then performs capture with 0.5 s writes.

```bash
chmod +x run_les.sh
NP=8 SPIN_MULT=20 ./run_les.sh
```

Environment variables commonly used by the script:
- `NP` number of MPI ranks
- `SPIN_MULT` spin-up duration multiplier (turnover-time based)
- `CAPTURE_DT` capture write interval in seconds (default 0.5)
- `CAPTURE_DURATION` capture duration in seconds (default 200)
- `RECONSTRUCT` set to 1 to reconstruct parallel fields into single-domain time folders

### Option B  Manual workflow

```bash
# 1) mesh and forcing zone
blockMesh
topoSet

# 2) parallel decomposition (optional)
decomposePar -force

# 3) spin-up
cp system/controlDict.spinup system/controlDict
mpirun -np 8 pimpleFoam -parallel | tee log.spinup

# 4) capture (0.5 s cadence)
cp system/controlDict.capture system/controlDict
mpirun -np 8 pimpleFoam -parallel | tee log.capture
```

## Export velocity cubes to NumPy

The exporter expects reconstructed (single-domain) time folders in the selected run directory. If you ran in parallel and only have `processor*/TIME/U`, run with `RECONSTRUCT=1` or execute `reconstructPar` for the capture times.

Export from the latest run:

```bash
python3 export_cube.py --latest --out-name U_all
```

Outputs:
- `U_all.npy` with tensor layout `(T, Nz, Ny, Nx, 3)`
- `U_all.meta.json` with grid, domain, and time metadata

## Repository hygiene and large files

OpenFOAM mesh connectivity files such as `constant/polyMesh/faces` can exceed GitHub’s 100 MB file limit. This repository should not track:
- `constant/polyMesh/`
- solver time folders (e.g., `0.5/`, `35.285984/`, …)
- `processor*/`, `runs/`, `postProcessing/`, `log.*`
- exported arrays such as `*.npy`

A practical `.gitignore` is:

```gitignore
# OpenFOAM generated mesh and outputs
constant/polyMesh/
processor*/
postProcessing/
runs/
log.*
*.foam

# Exported datasets
*.npy
*.npz

# Ignore time directories; keep initial conditions in ./0
0.*
[1-9]*/
```

## Related publication

A closely aligned neutral ABL LES configuration (domain size, periodic lateral boundaries, rough-wall roughness length, and mean-flow forcing strategy) is described and used as reference data in:

Chen, Y., Wang, D., Feng, D., Tian, G., Gupta, V., Cao, R., Wan, M., Chen, S., “Three-dimensional spatiotemporal wind field reconstruction based on LiDAR and multi-scale PINN,” *Applied Energy*, 377 (2025) 124577. https://doi.org/10.1016/j.apenergy.2024.124577
